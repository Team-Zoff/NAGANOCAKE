<%# viewで必要な計算 %>
  <% total = 0 %>
  <% tax = 1.10 %>
  <% postage = @order.order_details.shipping_free %>

<%# 合計金額の計算 %>
  <% @order.order_details.each do |order_detail| %>
    <% subtotal = order_detail.product.price_excluding_tax * order_detail.purchase_quantity %>
    <% total = total + subtotal %>
  <% end %>

<%# 請求金額の計算 %>
  <% billingamount = postage + total %>

<%# view画面 %>
<div class="row">
  <h2>注文履歴詳細</h2>
  <div class="col-xs-6">
    <h4>注文情報</h4>
    <table class = 'table-bordered'>
      <thead>
        <tr>
          <th>注文日</th><th><%= @order.order_details.created_at %></th>
        </tr>
        <tr>
          <th>配送先</th>
          <th><%= @order.order_details.postal_code %><br>
            <%= @order.order_details.address %><br>
            <%= @order.order_details.address_name %>
          </th>
        </tr>
        <tr>
          <th>支払方法</th><th><%= @order.order_details.method_of_payment %></th>
        </tr>
        <tr>
          <th>ステータス</th><th><%= @order.order_details.order_status %></th>
        </tr>
      </thead>
    </table>
  </div>

  <div class="col-xs-6 ml-1">
    <h4>請求情報</h4>
    <table class = 'table-bordered'>
      <thead>
        <tr>
          <th>商品の合計</th><th><%= total %></th>
        </tr>
        <tr>
          <th>配送料</th><th><%= postage %></th>
        </tr>
        <tr>
          <th>ご請求額</th><th><%= billingamount %></th>
        </tr>
      </thead>
    </table>
  </div>
</div>

<div class="row">
  <div>
    <h4>注文内容</h4>
    <table class = 'table-bordered' >
      <thead>
        <tr>
          <th>商品</th><th>単価(税込み)</th><th>個数</th><th>小計</th>
        </tr>
      </thead>
      <tbody>
        <% total = 0 %>
        <% @order.order_details.each do |order_detail| %>
        <tr>
          <td>
            <%= order_detail.product.name %>
          </td>
          <td>
            <%= order_detail.product.price_excluding_tax * tax %>
          </td>
          <td>
            <%= order_detail.purchase_quantity %>
          </td>
          <td>
            <%= subtotal = order_detail.product.price_excluding_tax * order_detail.purchase_quantity %>
          </td>
        </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
